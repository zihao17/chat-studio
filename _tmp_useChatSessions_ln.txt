1	import { useState, useEffect, useCallback, useRef } from "react";
2	import {
3	  type ChatSession,
4	  type Message,
5	  type AttachmentMeta,
6	  STORAGE_KEYS,
7	  generateId,
8	  generateMessageId,
9	  generateSessionTitle,
10	} from "../types/chat";
11	import { callAIChatStream, type ChatMessage } from "../utils/aiApi";
12	import { useAuth } from "../contexts/AuthContext";
13	import { useChatSync } from "./useChatSync";
14	
15	/**
16	 * ä¼šè¯çŠ¶æ€ç®¡ç†Hook
17	 * æä¾›ä¼šè¯çš„åˆ›å»ºã€åˆ‡æ¢ã€åˆ é™¤ç­‰åŠŸèƒ½
18	 */
19	export const useChatSessions = () => {
20	  const { state: authState } = useAuth();
21	  const chatSync = useChatSync();
22	  const [sessions, setSessions] = useState<ChatSession[]>([]);
23	  const [currentSessionId, setCurrentSessionId] = useState<string | null>(null);
24	  const [currentModel, setCurrentModel] = useState<string>("Qwen/Qwen3-Next-80B-A3B-Instruct"); // é»˜è®¤æ¨¡å‹
25	  // é«˜çº§è®¾ç½®ï¼šæ¸©åº¦ã€top_pã€ç³»ç»Ÿæç¤ºè¯ï¼ˆç³»ç»Ÿæç¤ºè¯é»˜è®¤ä¸ç”Ÿæ•ˆï¼Œä»…ä½œå ä½å±•ç¤ºï¼‰
26	  const [temperature, setTemperature] = useState<number>(0.7);
27	  const [topP, setTopP] = useState<number>(0.9);
28	  const [systemPrompt, setSystemPrompt] = useState<string>("");
29	  // RAGï¼šçŸ¥è¯†åº“å¼€å…³ä¸å½“å‰é›†åˆ
30	  const [kbEnabled, setKbEnabled] = useState<boolean>(false);
31	  const [kbCollectionId, setKbCollectionId] = useState<number | undefined>(undefined);
32	  // å­˜å‚¨æ¯ä¸ªä¼šè¯çš„AbortControllerï¼Œç”¨äºä¸­æ–­æµå¼å“åº”
33	  const abortControllersRef = useRef<Map<string, AbortController>>(new Map());
34	  // æ ‡è®°æ˜¯å¦å·²ç»è¿›è¡Œè¿‡ç™»å½•åçš„æ•°æ®åŒæ­¥
35	  const [hasSyncedAfterLogin, setHasSyncedAfterLogin] = useState(false);
36	
37	  // é˜²æŠ–ä¿å­˜çš„å¼•ç”¨
38	  const saveTimeoutRef = useRef<number | undefined>(undefined);
39	  // è‡ªåŠ¨åˆ›å»ºä¼šè¯çš„å»¶æ—¶å™¨å¼•ç”¨
40	  const autoCreateTimeoutRef = useRef<number | undefined>(undefined);
41	
42	  // è·å–å½“å‰æ´»è·ƒä¼šè¯
43	  const currentSession =
44	    sessions.find((session) => session.id === currentSessionId) || null;
45	
46	  // è·å–å½“å‰ä¼šè¯çš„åŠ è½½çŠ¶æ€
47	  const isAILoading = currentSession?.isLoading || false;
48	
49	  // è·å–æŒ‡å®šä¼šè¯çš„ç”ŸæˆçŠ¶æ€
50	  const isSessionGenerating = useCallback(
51	    (sessionId: string) => {
52	      const session = sessions.find((s) => s.id === sessionId);
53	      return session?.isLoading || false;
54	    },
55	    [sessions]
56	  );
57	
58	  // åœæ­¢æŒ‡å®šä¼šè¯çš„ç”Ÿæˆ
59	  const stopGeneration = useCallback(
60	    (sessionId: string) => {
61	      const abortController = abortControllersRef.current.get(sessionId);
62	      if (abortController) {
63	        abortController.abort();
64	        abortControllersRef.current.delete(sessionId);
65	
66	        // æŸ¥æ‰¾å¹¶æ›´æ–°æ­£åœ¨åŠ è½½çš„æ¶ˆæ¯ï¼ŒåŒæ—¶æ¸…é™¤ä¼šè¯çš„åŠ è½½çŠ¶æ€
67	        const session = sessions.find((s) => s.id === sessionId);
68	        if (session) {
69	          const loadingMessage = session.messages.find((m) => m.isLoading);
70	          if (loadingMessage) {
71	            // å¦‚æœæ¶ˆæ¯å†…å®¹ä¸ºç©ºæˆ–åªæœ‰ç©ºç™½å­—ç¬¦ï¼Œåˆ é™¤è¿™æ¡æ¶ˆæ¯
72	            if (!loadingMessage.content || !loadingMessage.content.trim()) {
73	              // åˆ é™¤ç©ºçš„åŠ è½½æ¶ˆæ¯ï¼Œé¿å…å½±å“åç»­è¯·æ±‚
74	              setSessions((prevSessions) =>
75	                prevSessions.map((s) =>
76	                  s.id === sessionId
77	                    ? {
78	                        ...s,
79	                        messages: s.messages.filter((m) => m.id !== loadingMessage.id),
80	                        isLoading: false, // æ¸…é™¤ä¼šè¯åŠ è½½çŠ¶æ€
81	                        updatedAt: Date.now(),
82	                      }
83	                    : s
84	                )
85	              );
86	            } else {
87	              // å¦‚æœæœ‰å†…å®¹ï¼Œæ·»åŠ åœæ­¢æ ‡è®°
88	              setSessions((prevSessions) =>
89	                prevSessions.map((s) =>
90	                  s.id === sessionId
91	                    ? {
92	                        ...s,
93	                        messages: s.messages.map((msg) =>
94	                          msg.id === loadingMessage.id
95	                            ? {
96	                                ...msg,
97	                                content: msg.content + "\n\n[ç”Ÿæˆå·²åœæ­¢]",
98	                                isLoading: false,
99	                              }
100	                            : msg
101	                        ),
102	                        isLoading: false, // æ¸…é™¤ä¼šè¯åŠ è½½çŠ¶æ€
103	                        updatedAt: Date.now(),
104	                      }
105	                    : s
106	                )
107	              );
108	            }
109	          } else {
110	            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŠ è½½ä¸­çš„æ¶ˆæ¯ï¼Œåªæ¸…é™¤ä¼šè¯åŠ è½½çŠ¶æ€
111	            setSessions((prevSessions) =>
112	              prevSessions.map((s) =>
113	                s.id === sessionId
114	                  ? { ...s, isLoading: false, updatedAt: Date.now() }
115	                  : s
116	              )
117	            );
118	          }
119	        }
120	      }
121	    },
122	    [sessions, setSessions]
123	  );
124	
125	  // é˜²æŠ–ä¿å­˜åˆ°localStorageï¼ˆä»…åœ¨æ¸¸å®¢æ¨¡å¼ä¸‹ï¼‰
126	  const debouncedSave = useCallback(
127	    (
128	      sessionsToSave: ChatSession[],
129	      currentId: string | null,
130	      modelId?: string
131	    ) => {
132	      // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œä¸ä¿å­˜åˆ°localStorage
133	      if (authState.isAuthenticated) {
134	        return;
135	      }
136	
137	      if (saveTimeoutRef.current) {
138	        clearTimeout(saveTimeoutRef.current);
139	      }
140	
141	      saveTimeoutRef.current = setTimeout(() => {
142	        try {
143	          localStorage.setItem(
144	            STORAGE_KEYS.CHAT_SESSIONS,
145	            JSON.stringify(sessionsToSave)
146	          );
147	          if (currentId) {
148	            localStorage.setItem(STORAGE_KEYS.CURRENT_SESSION_ID, currentId);
149	          }
150	          if (modelId) {
151	            localStorage.setItem(STORAGE_KEYS.CURRENT_MODEL, modelId);
152	          }
153	        } catch (error) {
154	          console.error("ä¿å­˜ä¼šè¯æ•°æ®å¤±è´¥:", error);
155	        }
156	      }, 500);
157	    },
158	    [authState.isAuthenticated]
159	  );
160	
161	  // è®¾ç½®å½“å‰æ¨¡å‹å¹¶ä¿å­˜åˆ°localStorage
162	  const handleSetCurrentModel = useCallback(
163	    (modelId: string) => {
164	      setCurrentModel(modelId);
165	      // ä¿å­˜åˆ°localStorageï¼ˆä»…åœ¨æ¸¸å®¢æ¨¡å¼ä¸‹ï¼‰
166	      if (!authState.isAuthenticated) {
167	        debouncedSave(sessions, currentSessionId, modelId);
168	      }
169	    },
170	    [authState.isAuthenticated, sessions, currentSessionId, debouncedSave]
171	  );
172	
173	  // è®¾ç½®æŒ‡å®šä¼šè¯çš„åŠ è½½çŠ¶æ€
174	  const setSessionLoading = useCallback(
175	    (sessionId: string, loading: boolean) => {
176	      setSessions((prev) => {
177	        const prevSessions = Array.isArray(prev) ? prev : [];
178	        const updated = prevSessions.map((session) =>
179	          session.id === sessionId
180	            ? { ...session, isLoading: loading, updatedAt: Date.now() }
181	            : session
182	        );
183	        debouncedSave(updated, currentSessionId);
184	        return updated;
185	      });
186	    },
187	    [currentSessionId, debouncedSave]
188	  );
189	
190	  // ä»localStorageåŠ è½½æ•°æ®ï¼ˆä»…åœ¨æ¸¸å®¢æ¨¡å¼ä¸‹ï¼‰
191	  const loadFromStorage = useCallback(() => {
192	    // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œä¸ä»localStorageåŠ è½½
193	    if (authState.isAuthenticated) {
194	      return;
195	    }
196	
197	    try {
198	      const savedSessions = localStorage.getItem(STORAGE_KEYS.CHAT_SESSIONS);
199	      const savedCurrentId = localStorage.getItem(
200	        STORAGE_KEYS.CURRENT_SESSION_ID
201	      );
202	      const savedModel = localStorage.getItem(STORAGE_KEYS.CURRENT_MODEL);
203	      const savedAdvanced = localStorage.getItem(STORAGE_KEYS.ADVANCED_SETTINGS);
204	
205	      // æ¢å¤æ¨¡å‹é€‰æ‹©
206	      if (savedModel) {
207	        setCurrentModel(savedModel);
208	      }
209	
210	      // æ¢å¤é«˜çº§è®¾ç½®
211	      if (savedAdvanced) {
212	        try {
213	          const parsed = JSON.parse(savedAdvanced) as { temperature?: number; topP?: number; systemPrompt?: string };
214	          const clamp = (v: number) => Math.min(1.0, Math.max(0.1, v));
215	          const round1 = (v: number) => Math.round(v * 10) / 10;
216	          if (typeof parsed.temperature === 'number') setTemperature(round1(clamp(parsed.temperature)));
217	          if (typeof parsed.topP === 'number') setTopP(round1(clamp(parsed.topP)));
218	          if (typeof parsed.systemPrompt === 'string') setSystemPrompt(parsed.systemPrompt.trim() === '' ? '' : parsed.systemPrompt);
219	        } catch {}
220	      }
221	
222	      if (savedSessions) {
223	        const parsedSessions: ChatSession[] = JSON.parse(savedSessions);
224	        setSessions(parsedSessions);
225	
226	        // æ¢å¤å½“å‰ä¼šè¯
227	        if (
228	          savedCurrentId &&
229	          parsedSessions.find((s) => s.id === savedCurrentId)
230	        ) {
231	          setCurrentSessionId(savedCurrentId);
232	        } else if (parsedSessions.length > 0) {
233	          // å¦‚æœæ²¡æœ‰ä¿å­˜çš„å½“å‰ä¼šè¯IDï¼Œé€‰æ‹©æœ€æ–°çš„ä¼šè¯
234	          const latestSession = parsedSessions.sort(
235	            (a, b) => b.updatedAt - a.updatedAt
236	          )[0];
237	          setCurrentSessionId(latestSession.id);
238	        }
239	      }
240	    } catch (error) {
241	      console.error("åŠ è½½ä¼šè¯æ•°æ®å¤±è´¥:", error);
242	    }
243	  }, [authState.isAuthenticated]);
244	
245	  // æŒä¹…åŒ–é«˜çº§è®¾ç½®åˆ°æœ¬åœ°
246	  useEffect(() => {
247	    const payload = JSON.stringify({ temperature, topP, systemPrompt });
248	    try {
249	      localStorage.setItem(STORAGE_KEYS.ADVANCED_SETTINGS, payload);
250	    } catch {}
251	  }, [temperature, topP, systemPrompt]);
252	
253	  // åˆ›å»ºæ–°ä¼šè¯
254	  const createNewSession = useCallback((): ChatSession => {
255	    const newSession: ChatSession = {
256	      id: generateId(),
257	      title: "æ–°å¯¹è¯",
258	      messages: [],
259	      createdAt: Date.now(),
260	      updatedAt: Date.now(),
261	    };
262	
263	    console.log("ğŸ¯ åˆ›å»ºæ–°ä¼šè¯", {
264	      sessionId: newSession.id,
265	      title: newSession.title,
266	      timestamp: new Date(newSession.createdAt).toLocaleString()
267	    });
268	
269	    setSessions((prev) => {
270	      // ç¡®ä¿ prev æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé˜²æ­¢ "prev is not iterable" é”™è¯¯
271	      const prevSessions = Array.isArray(prev) ? prev : [];
272	      const updated = [newSession, ...prevSessions];
273	      debouncedSave(updated, newSession.id);
274	      return updated;
275	    });
276	
277	    setCurrentSessionId(newSession.id);
278	    return newSession;
279	  }, [debouncedSave]);
280	
281	  // åˆ‡æ¢åˆ°æŒ‡å®šä¼šè¯
282	  const switchToSession = useCallback(
283	    (sessionId: string) => {
284	      const targetSession = sessions.find((s) => s.id === sessionId);
285	      if (targetSession) {
286	        setCurrentSessionId(sessionId);
287	        debouncedSave(sessions, sessionId);
288	      }
289	    },
290	    [sessions, debouncedSave]
291	  );
292	
293	  // åˆ é™¤ä¼šè¯
294	  const deleteSession = useCallback(
295	    (sessionId: string) => {
296	      setSessions((prev) => {
297	        // ç¡®ä¿ prev æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé˜²æ­¢ "prev is not iterable" é”™è¯¯
298	        const prevSessions = Array.isArray(prev) ? prev : [];
299	        const updated = prevSessions.filter((s) => s.id !== sessionId);
300	
301	        // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ä¼šè¯ï¼Œéœ€è¦åˆ‡æ¢åˆ°å…¶ä»–ä¼šè¯
302	        if (sessionId === currentSessionId) {
303	          const newCurrentId = updated.length > 0 ? updated[0].id : null;
304	          setCurrentSessionId(newCurrentId);
305	          debouncedSave(updated, newCurrentId);
306	        } else {
307	          debouncedSave(updated, currentSessionId);
308	        }
309	
310	        return updated;
311	      });
312	
313	      // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼ŒåŒæ—¶åˆ é™¤äº‘ç«¯æ•°æ®
314	      if (authState.isAuthenticated) {
315	        chatSync.deleteSession(sessionId);
316	      }
317	    },
318	    [currentSessionId, debouncedSave, authState.isAuthenticated, chatSync]
319	  );
320	
321	  // æ›´æ–°ä¼šè¯æ ‡é¢˜
322	  const updateSessionTitle = useCallback(
323	    (sessionId: string, title: string) => {
324	      setSessions((prev) => {
325	        // ç¡®ä¿ prev æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé˜²æ­¢ "prev is not iterable" é”™è¯¯
326	        const prevSessions = Array.isArray(prev) ? prev : [];
327	        const updated = prevSessions.map((session) =>
328	          session.id === sessionId
329	            ? { ...session, title, updatedAt: Date.now() }
330	            : session
331	        );
332	        debouncedSave(updated, currentSessionId);
333	        return updated;
334	      });
335	    },
336	    [currentSessionId, debouncedSave]
337	  );
338	
339	  // æ·»åŠ æ¶ˆæ¯
340	  const addMessage = useCallback(
341	    (sessionId: string, messageData: Omit<Message, "id" | "timestamp">) => {
342	      const newMessage: Message = {
343	        ...messageData,
344	        id: generateMessageId(),
345	        timestamp: Date.now(),
346	      };
347	
348	      setSessions((prev) => {
349	        // ç¡®ä¿ prev æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé˜²æ­¢ "prev is not iterable" é”™è¯¯
350	        const prevSessions = Array.isArray(prev) ? prev : [];
351	        const updated = prevSessions.map((session) => {
352	          if (session.id === sessionId) {
353	            const updatedMessages = [...session.messages, newMessage];
354	            return {
355	              ...session,
356	              messages: updatedMessages,
357	              updatedAt: Date.now(),
358	            };
359	          }
360	          return session;
361	        });
362	        debouncedSave(updated, currentSessionId);
363	        return updated;
364	      });
365	
366	      // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼ŒåŒæ—¶ä¿å­˜åˆ°äº‘ç«¯
367	      if (authState.isAuthenticated && !messageData.isLoading) {
368	        // ä¸åœ¨è¿™é‡Œä¿å­˜æ¶ˆæ¯ï¼Œé¿å…é‡å¤ä¿å­˜
369	        // ç”¨æˆ·æ¶ˆæ¯åœ¨sendMessageä¸­ä¿å­˜ï¼ŒAIæ¶ˆæ¯åœ¨æµå¼å®Œæˆåä¿å­˜
370	      }
371	
372	      return newMessage;
373	    },
374	    [currentSessionId, debouncedSave, authState.isAuthenticated, chatSync]
375	  );
376	
377	  // æ›´æ–°æ¶ˆæ¯
378	  const updateMessage = useCallback(
379	    (sessionId: string, messageId: string, updates: Partial<Message>) => {
380	      setSessions((prev) => {
381	        // ç¡®ä¿ prev æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé˜²æ­¢ "prev is not iterable" é”™è¯¯
382	        const prevSessions = Array.isArray(prev) ? prev : [];
383	        const updated = prevSessions.map((session) => {
384	          if (session.id === sessionId) {
385	            const updatedMessages = session.messages.map((msg) =>
386	              msg.id === messageId ? { ...msg, ...updates } : msg
387	            );
388	            return {
389	              ...session,
390	              messages: updatedMessages,
391	              updatedAt: Date.now(),
392	            };
393	          }
394	          return session;
395	        });
396	        debouncedSave(updated, currentSessionId);
397	        return updated;
398	      });
399	    },
400	    [currentSessionId, debouncedSave]
401	  );
402	
403	  // å‘é€æ¶ˆæ¯å¹¶è·å–AIå›å¤ï¼ˆæµå¼ï¼‰
404	  const sendMessage = useCallback(
405	    async (
406	      content: string,
407	      attachmentsMeta?: AttachmentMeta[],
408	      options?: { displayContent?: string }
409	    ) => {
410	      if (!currentSessionId || !content.trim() || isAILoading) return;
411	
412	      const displayContent = (options?.displayContent ?? content).trim();
413	
414	      addMessage(currentSessionId, {
415	        role: "user",
416	        content: displayContent,
417	        attachments: attachmentsMeta,
418	      });
419	
420	      // å¦‚æœæ˜¯ä¼šè¯çš„ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ï¼Œæ›´æ–°ä¼šè¯æ ‡é¢˜
421	      const session = sessions.find((s) => s.id === currentSessionId);
422	      const isFirstUserMessage =
423	        session &&
424	        session.messages.filter((m) => m.role === "user").length === 0;
425	
426	      // æ„é€ äº‘ç«¯ä¿å­˜å†…å®¹ï¼šå¯¹ç”¨æˆ·æ¶ˆæ¯ç”¨åŒ…è£…æ ¼å¼ä¿ç•™é™„ä»¶å…ƒä¿¡æ¯ï¼ˆä¸ä¿å­˜å¤§æ®µæ–‡æœ¬ï¼‰
427	      const buildCloudContent = (
428	        role: "user" | "assistant",
429	        display: string,
430	        atts?: AttachmentMeta[]
431	      ): string => {
432	        if (role !== "user") return display;
433	        try {
434	          return JSON.stringify({
435	            __type: "chatstudio.msg",
436	            v: 1,
437	            role,
438	            display,
439	            attachments: Array.isArray(atts) ? atts : [],
440	          });
441	        } catch {
442	          return display;
443	        }
444	      };
445	
446	      if (isFirstUserMessage) {
447	        const newTitle = generateSessionTitle(displayContent);
448	        updateSessionTitle(currentSessionId, newTitle);
449	
450	        // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼ŒåŒæ—¶ä¿å­˜æ ‡é¢˜åˆ°äº‘ç«¯
451	        if (authState.isAuthenticated) {
452	          try {
453	            await chatSync.saveMessage(
454	              currentSessionId,
455	              "user",
456	              buildCloudContent("user", displayContent, attachmentsMeta),
457	              newTitle
458	            );
459	            console.log("ç”¨æˆ·æ¶ˆæ¯å’Œæ ‡é¢˜å·²ä¿å­˜åˆ°äº‘ç«¯");
460	          } catch (error) {
461	            console.error("ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ°äº‘ç«¯å¤±è´¥:", error);
462	            // ä¸å½±å“ç”¨æˆ·ä½“éªŒï¼Œæ¶ˆæ¯å·²åœ¨æœ¬åœ°ä¿å­˜
463	          }
464	        }
465	      } else {
466	        // ä¸æ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œæ­£å¸¸ä¿å­˜
467	        if (authState.isAuthenticated) {
468	          try {
469	            await chatSync.saveMessage(
470	              currentSessionId,
471	              "user",
472	              buildCloudContent("user", displayContent, attachmentsMeta)
473	            );
474	            console.log("ç”¨æˆ·æ¶ˆæ¯å·²ä¿å­˜åˆ°äº‘ç«¯");
475	          } catch (error) {
476	            console.error("ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ°äº‘ç«¯å¤±è´¥:", error);
477	            // ä¸å½±å“ç”¨æˆ·ä½“éªŒï¼Œæ¶ˆæ¯å·²åœ¨æœ¬åœ°ä¿å­˜
478	          }
479	        }
480	      }
481	
482	      // æ·»åŠ AIåŠ è½½æ¶ˆæ¯
483	      const loadingMessage = addMessage(currentSessionId, {
484	        role: "assistant",
485	        content: "",
486	        isLoading: true,
487	      });
488	
489	      // è®¾ç½®å½“å‰ä¼šè¯çš„åŠ è½½çŠ¶æ€
490	      setSessionLoading(currentSessionId, true);
491	
492	      // åˆ›å»ºAbortControllerç”¨äºä¸­æ–­è¯·æ±‚
493	      const abortController = new AbortController();
494	      abortControllersRef.current.set(currentSessionId, abortController);
495	
496	      try {
497	        // å‡†å¤‡å‘é€ç»™AIçš„æ¶ˆæ¯å†å²
498	        const chatMessages: ChatMessage[] =
499	          session?.messages
500	            .filter((m) => !m.isLoading && m.content && m.content.trim()) // è¿‡æ»¤æ‰åŠ è½½ä¸­çš„æ¶ˆæ¯å’Œç©ºå†…å®¹æ¶ˆæ¯
501	            .map((m) => ({
502	              role: m.role,
503	              content: m.content,
504	            })) || [];
505	
506	        // æ·»åŠ å½“å‰ç”¨æˆ·æ¶ˆæ¯
507	        chatMessages.push({
508	          role: "user",
509	          content: content.trim(),
510	        });
511	
512	        // ç”¨äºç´¯ç§¯æµå¼å“åº”å†…å®¹
513	        let accumulatedContent = "";
514	        // æ ‡è®°æ˜¯å¦å‘ç”Ÿé”™è¯¯ï¼Œé¿å…åœ¨é”™è¯¯åç”¨ç©ºå†…å®¹è¦†ç›–é”™è¯¯æç¤º
515	        let errorOccurred = false;
516	        // é«˜é¢‘chunkåˆå¹¶ç›¸å…³å˜é‡
517	        let chunkBuffer = "";
518	        let chunkTimer: number | null = null;
519	
520	        // åˆå¹¶chunkæ›´æ–°çš„å‡½æ•°
521	        const flushChunkBuffer = () => {
522	          if (chunkBuffer) {
523	            accumulatedContent += chunkBuffer;
524	            updateMessage(currentSessionId, loadingMessage.id, {
525	              content: accumulatedContent,
526	              isLoading: true,
527	            });
528	            chunkBuffer = "";
529	          }
530	          chunkTimer = null;
531	        };
532	
533	        // è°ƒç”¨æµå¼AIæ¥å£
534	        await callAIChatStream(
535	          chatMessages,
536	          // onChunk: æ¥æ”¶åˆ°æ•°æ®å—æ—¶çš„å›è°ƒ
537	          (chunk: string) => {
538	            chunkBuffer += chunk;
539	            // æ¯15msåˆå¹¶ä¸€æ¬¡æ›´æ–°ï¼ˆå…¼é¡¾å®æ—¶æ€§å’Œæ€§èƒ½ï¼‰
540	            if (!chunkTimer) {
541	              chunkTimer = setTimeout(flushChunkBuffer, 15); // 15msçº¦ä¸º60fpsçš„å•å¸§æ—¶é—´ï¼Œå‡å°‘DOMæ›´æ–°é¢‘ç‡
542	            }
543	          },
544	          // onError: é”™è¯¯å¤„ç†å›è°ƒ
545	          (error: string) => {
546	            // æ¸…é™¤pendingçš„chunkæ›´æ–°
547	            if (chunkTimer) {
548	              clearTimeout(chunkTimer);
549	              chunkTimer = null;
550	            }
551	            // ç¡®ä¿æœ€åä¸€æ‰¹chunkè¢«æ›´æ–°
552	            if (chunkBuffer) {
553	              accumulatedContent += chunkBuffer;
554	              chunkBuffer = "";
555	            }
556	            
557	            console.error("AIæµå¼å›å¤å¤±è´¥:", error);
558	            // ä»¥ä¸€æ¡ AI æ¶ˆæ¯çš„å½¢å¼å±•ç¤ºå‹å¥½é”™è¯¯æç¤ºï¼Œä¿ç•™åœ¨å¯¹è¯å†å²
559	            updateMessage(currentSessionId, loadingMessage.id, {
560	              content: error,
561	              isLoading: false,
562	              // æ ‡è®°ä¸ºé”™è¯¯æ¶ˆæ¯ï¼Œç”¨äº UI å±‚è¯†åˆ«ï¼ˆæ ·å¼ä¿æŒä¸æ™®é€š AI æ¶ˆæ¯ä¸€è‡´ï¼‰
563	              isError: true,
564	            });
565	            errorOccurred = true;
566	            setSessionLoading(currentSessionId, false);
567	            abortControllersRef.current.delete(currentSessionId);
568	          },
569	          // onStats: æ¥æ”¶åˆ°ç»Ÿè®¡ä¿¡æ¯æ—¶çš„å›è°ƒ
570	          (stats) => {
571	            // å°†ç»Ÿè®¡ä¿¡æ¯æ·»åŠ åˆ°æ¶ˆæ¯ä¸­
572	            updateMessage(currentSessionId, loadingMessage.id, {
573	              stats: stats,
574	            });
575	          },
576	          currentModel, // ä½¿ç”¨å½“å‰é€‰ä¸­çš„æ¨¡å‹
577	          {
578	            temperature,
579	            top_p: topP,
580	            abortController,
581	            user_system_prompt: systemPrompt,
582	            kb_enabled: kbEnabled,
583	            kb_collection_id: kbCollectionId,
584	            kb_top_k: 6,
585	          }
586	        );
587	
588	        // æµå¼ä¼ è¾“å®Œæˆï¼Œæ¸…é™¤åŠ è½½çŠ¶æ€ï¼ˆä»…åœ¨æœªå‘ç”Ÿé”™è¯¯æ—¶æ›´æ–°æœ€ç»ˆå†…å®¹ï¼‰
589	        if (!errorOccurred) {
590	          // æ¸…é™¤pendingçš„chunkæ›´æ–°å¹¶ç¡®ä¿æœ€åä¸€æ‰¹chunkè¢«æ›´æ–°
591	          if (chunkTimer) {
592	            clearTimeout(chunkTimer);
593	            chunkTimer = null;
594	          }
595	          if (chunkBuffer) {
596	            accumulatedContent += chunkBuffer;
597	            chunkBuffer = "";
598	          }
599	          
600	          updateMessage(currentSessionId, loadingMessage.id, {
601	            content: accumulatedContent,
602	            isLoading: false,
603	          });
604	
605	          // AIå›å¤å®Œæˆåï¼Œä¿å­˜åˆ°äº‘ç«¯
606	          if (authState.isAuthenticated && accumulatedContent.trim()) {
607	            try {
608	              await chatSync.saveMessage(
609	                currentSessionId,
610	                "assistant",
611	                accumulatedContent
612	              );
613	              console.log("AIæ¶ˆæ¯å·²ä¿å­˜åˆ°äº‘ç«¯");
614	            } catch (error) {
615	              console.error("ä¿å­˜AIæ¶ˆæ¯åˆ°äº‘ç«¯å¤±è´¥:", error);
616	              // ä¸å½±å“ç”¨æˆ·ä½“éªŒï¼Œæ¶ˆæ¯å·²åœ¨æœ¬åœ°ä¿å­˜
617	            }
618	          }
619	        }
620	      } catch (error) {
621	        console.error("AIå›å¤å¤±è´¥:", error);
622	
623	        // æ›´æ–°é”™è¯¯æ¶ˆæ¯ï¼ˆç»Ÿä¸€ä¸ºå‹å¥½æç¤ºï¼‰
624	        updateMessage(currentSessionId, loadingMessage.id, {
625	          content: "ğŸ¤– AI æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•ã€‚",
626	          isLoading: false,
627	          isError: true,
628	        });
629	      } finally {
630	        // æ¸…é™¤å½“å‰ä¼šè¯çš„åŠ è½½çŠ¶æ€å’ŒAbortController
631	        setSessionLoading(currentSessionId, false);
632	        abortControllersRef.current.delete(currentSessionId);
633	      }
634	    },
635	    [
636	      currentSessionId,
637	      isAILoading,
638	      sessions,
639	      addMessage,
640	      updateSessionTitle,
641	      updateMessage,
642	      setSessionLoading,
643	      currentModel,
644	      authState.isAuthenticated,
645	      chatSync,
646	    ]
647	  );
648	
649	  // æ™ºèƒ½æ–°å¯¹è¯é€»è¾‘
650	  const handleNewChat = useCallback(() => {
651	    console.log("ğŸ”„ è§¦å‘æ–°å¯¹è¯é€»è¾‘");
652	    
653	    // æ£€æŸ¥å½“å‰æœ€æ–°ä¼šè¯æ˜¯å¦ä¸ºç©º
654	    if (sessions.length > 0) {
655	      const latestSession = sessions.sort(
656	        (a, b) => b.updatedAt - a.updatedAt
657	      )[0];
658	      const hasUserMessages = latestSession.messages.some(
659	        (m) => m.role === "user"
660	      );
661	
662	      if (!hasUserMessages) {
663	        // å¦‚æœæœ€æ–°ä¼šè¯æ²¡æœ‰ç”¨æˆ·æ¶ˆæ¯ï¼Œç›´æ¥åˆ‡æ¢åˆ°è¯¥ä¼šè¯
664	        console.log("âœ… æƒ…å†µ1ï¼šå¤ç”¨ç©ºä¼šè¯ - æœ€æ–°ä¼šè¯æ— ç”¨æˆ·æ¶ˆæ¯ï¼Œç›´æ¥åˆ‡æ¢", {
665	          sessionId: latestSession.id,
666	          title: latestSession.title,
667	          messageCount: latestSession.messages.length
668	        });
669	        switchToSession(latestSession.id);
670	        return;
671	      }
672	    }
673	
674	    // å¦åˆ™åˆ›å»ºæ–°ä¼šè¯
675	    console.log("ğŸ†• æƒ…å†µ1ï¼šåˆ›å»ºæ–°ä¼šè¯ - ç”¨æˆ·ä¸»åŠ¨ç‚¹å‡»æ–°å¯¹è¯æŒ‰é’®", {
676	      existingSessions: sessions.length,
677	      reason: sessions.length === 0 ? "æ— ç°æœ‰ä¼šè¯" : "æœ€æ–°ä¼šè¯å·²æœ‰ç”¨æˆ·æ¶ˆæ¯"
678	    });
679	    createNewSession();
680	  }, [sessions, switchToSession, createNewSession]);
681	
682	  // å¤„ç†ç”¨æˆ·ç™»å½•åçš„æ•°æ®åŒæ­¥
683	  useEffect(() => {
684	    const handleLoginSync = async () => {
685	      if (
686	        authState.isAuthenticated &&
687	        !hasSyncedAfterLogin &&
688	        !chatSync.isSyncing
689	      ) {
690	        console.log("ç”¨æˆ·ç™»å½•æˆåŠŸï¼Œæ•°æ®åŒæ­¥å°†è‡ªåŠ¨è¿›è¡Œ");
691	
692	        // æ·»åŠ å»¶è¿Ÿç¡®ä¿cookieå®Œå…¨è®¾ç½®
693	        await new Promise(resolve => setTimeout(resolve, 500));
694	
695	        try {
696	          // è·å–æœ¬åœ°æ¸¸å®¢æ•°æ®
697	          const guestSessions = localStorage.getItem(
698	            STORAGE_KEYS.CHAT_SESSIONS
699	          );
700	          const parsedGuestSessions: ChatSession[] = guestSessions
701	            ? JSON.parse(guestSessions)
702	            : [];
703	
704	          // åŠ è½½äº‘ç«¯æ•°æ®ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
705	          const cloudSessions = await loadCloudDataWithRetry();
706	
707	          if (parsedGuestSessions.length > 0) {
708	            console.log(`å‘ç° ${parsedGuestSessions.length} ä¸ªæ¸¸å®¢ä¼šè¯ï¼Œå¼€å§‹åŒæ­¥åˆ°äº‘ç«¯`);
709	            // æœ‰æ¸¸å®¢æ•°æ®ï¼Œéœ€è¦åŒæ­¥åˆ°äº‘ç«¯
710	            const syncSuccess = await syncGuestDataWithRetry(parsedGuestSessions);
711	
712	            if (syncSuccess) {
713	              console.log("æ¸¸å®¢æ•°æ®åŒæ­¥æˆåŠŸï¼Œé‡æ–°åŠ è½½äº‘ç«¯æ•°æ®");
714	              // åŒæ­¥æˆåŠŸåï¼Œé‡æ–°åŠ è½½äº‘ç«¯æ•°æ®ï¼ˆåŒ…å«åˆšåŒæ­¥çš„æ•°æ®ï¼‰
715	              const updatedCloudSessions = await loadCloudDataWithRetry();
716	              setSessions(updatedCloudSessions);
717	              console.log(`åŒæ­¥ååŠ è½½åˆ° ${updatedCloudSessions.length} ä¸ªäº‘ç«¯ä¼šè¯`);
718	
719	              // è®¾ç½®å½“å‰ä¼šè¯ä¸ºæœ€æ–°çš„ä¼šè¯
720	              if (updatedCloudSessions.length > 0) {
721	                const latestSession = updatedCloudSessions.sort(
722	                  (a, b) => b.updatedAt - a.updatedAt
723	                )[0];
724	                setCurrentSessionId(latestSession.id);
725	                console.log(`è®¾ç½®å½“å‰ä¼šè¯ä¸º: ${latestSession.title}`);
726	              }
727	
728	              // æ¸…ç©ºæœ¬åœ°æ¸¸å®¢æ•°æ®
729	              localStorage.removeItem(STORAGE_KEYS.CHAT_SESSIONS);
730	              localStorage.removeItem(STORAGE_KEYS.CURRENT_SESSION_ID);
731	              console.log("æ¸¸å®¢æ•°æ®åŒæ­¥æˆåŠŸï¼Œæœ¬åœ°æ•°æ®å·²æ¸…ç©º");
732	            } else {
733	              console.log("æ¸¸å®¢æ•°æ®åŒæ­¥å¤±è´¥ï¼Œä½¿ç”¨ç°æœ‰äº‘ç«¯æ•°æ®");
734	              // åŒæ­¥å¤±è´¥ï¼Œä½†ä¸æ¸…ç©ºæ¸¸å®¢æ•°æ®ï¼Œä¿ç•™åœ¨æœ¬åœ°
735	              // åˆå¹¶æ¸¸å®¢æ•°æ®å’Œäº‘ç«¯æ•°æ®æ˜¾ç¤ºç»™ç”¨æˆ·
736	              const mergedSessions = [...parsedGuestSessions, ...cloudSessions];
737	              setSessions(mergedSessions);
738	              
739	              if (mergedSessions.length > 0) {
740	                const latestSession = mergedSessions.sort(
741	                  (a, b) => b.updatedAt - a.updatedAt
742	                )[0];
743	                setCurrentSessionId(latestSession.id);
744	              }
745	              console.log(`åˆå¹¶æ˜¾ç¤º ${mergedSessions.length} ä¸ªä¼šè¯ï¼ˆæ¸¸å®¢+äº‘ç«¯ï¼‰`);
746	            }
747	          } else {
748	            console.log("æ²¡æœ‰æ¸¸å®¢æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨äº‘ç«¯æ•°æ®");
749	            // æ²¡æœ‰æ¸¸å®¢æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨äº‘ç«¯æ•°æ®
750	            setSessions(cloudSessions);
751	            if (cloudSessions.length > 0) {
752	              const latestSession = cloudSessions.sort(
753	                (a, b) => b.updatedAt - a.updatedAt
754	              )[0];
755	              setCurrentSessionId(latestSession.id);
756	            }
757	            console.log(`åŠ è½½ ${cloudSessions.length} ä¸ªäº‘ç«¯ä¼šè¯`);
758	          }
759	
760	          setHasSyncedAfterLogin(true);
761	        } catch (error) {
762	          console.error("ç™»å½•åæ•°æ®åŒæ­¥å¤±è´¥:", error);
763	          // åŒæ­¥å¤±è´¥æ—¶ï¼Œæ ‡è®°ä¸ºå·²åŒæ­¥ï¼Œé¿å…æ— é™é‡è¯•
764	          setHasSyncedAfterLogin(true);
765	        }
766	      }
767	    };
768	
769	    // å¸¦é‡è¯•æœºåˆ¶çš„äº‘ç«¯æ•°æ®åŠ è½½ - é™åˆ¶æœ€å¤§é‡è¯•æ¬¡æ•°
770	    const loadCloudDataWithRetry = async (maxRetries = 2): Promise<ChatSession[]> => {
771	      for (let i = 0; i < maxRetries; i++) {
772	        try {
773	          return await chatSync.loadCloudData();
774	        } catch (error: any) {
775	          console.warn(`åŠ è½½äº‘ç«¯æ•°æ®å¤±è´¥ (å°è¯• ${i + 1}/${maxRetries}):`, error.message);
776	          if (i === maxRetries - 1) {
777	            // æœ€åä¸€æ¬¡å¤±è´¥ï¼Œè¿”å›ç©ºæ•°ç»„è€Œä¸æ˜¯æŠ›å‡ºé”™è¯¯
778	            console.error("åŠ è½½äº‘ç«¯æ•°æ®æœ€ç»ˆå¤±è´¥ï¼Œä½¿ç”¨ç©ºæ•°æ®");
779	            return [];
780	          }
781	          // ç­‰å¾…åé‡è¯•ï¼Œä½¿ç”¨å›ºå®šå»¶è¿Ÿé¿å…æŒ‡æ•°å¢é•¿
782	          await new Promise(resolve => setTimeout(resolve, 1000));
783	        }
784	      }
785	      return [];
786	    };
787	
788	    // å¸¦é‡è¯•æœºåˆ¶çš„æ¸¸å®¢æ•°æ®åŒæ­¥ - é™åˆ¶æœ€å¤§é‡è¯•æ¬¡æ•°
789	    const syncGuestDataWithRetry = async (guestSessions: ChatSession[], maxRetries = 2): Promise<boolean> => {
790	      for (let i = 0; i < maxRetries; i++) {
791	        try {
792	          return await chatSync.syncGuestData(guestSessions);
793	        } catch (error: any) {
794	          console.warn(`åŒæ­¥æ¸¸å®¢æ•°æ®å¤±è´¥ (å°è¯• ${i + 1}/${maxRetries}):`, error.message);
795	          if (i === maxRetries - 1) {
796	            // æœ€åä¸€æ¬¡å¤±è´¥ï¼Œè¿”å›false
797	            console.error("åŒæ­¥æ¸¸å®¢æ•°æ®æœ€ç»ˆå¤±è´¥");
798	            return false;
799	          }
800	          // ç­‰å¾…åé‡è¯•ï¼Œä½¿ç”¨å›ºå®šå»¶è¿Ÿé¿å…æŒ‡æ•°å¢é•¿
801	          await new Promise(resolve => setTimeout(resolve, 1000));
802	        }
803	      }
804	      return false;
805	    };
806	
807	    // åªåœ¨è®¤è¯çŠ¶æ€å˜åŒ–ä¸”æœªåŒæ­¥æ—¶æ‰§è¡Œ
808	    if (authState.isAuthenticated && !hasSyncedAfterLogin) {
809	      handleLoginSync();
810	    }
811	  }, [authState.isAuthenticated, hasSyncedAfterLogin]); // ç§»é™¤chatSyncä¾èµ–ï¼Œé¿å…å¾ªç¯
812	
813	  // å¤„ç†ç”¨æˆ·ç™»å‡ºåçš„çŠ¶æ€é‡ç½®
814	  useEffect(() => {
815	    if (!authState.isAuthenticated && hasSyncedAfterLogin) {
816	      console.log("ğŸ‘‹ ç”¨æˆ·ç™»å‡ºï¼Œé‡ç½®çŠ¶æ€...");
817	      setHasSyncedAfterLogin(false);
818	      setSessions([]);
819	      setCurrentSessionId(null);
820	      console.log("ğŸ”„ æƒ…å†µ3ï¼šç™»å‡ºåé‡æ–°åŠ è½½æ¸¸å®¢æ•°æ®ï¼Œå°†è§¦å‘åˆå§‹ä¼šè¯åˆ›å»º");
821	      // é‡æ–°åŠ è½½æ¸¸å®¢æ•°æ®
822	      loadFromStorage();
823	    }
824	  }, [authState.isAuthenticated, hasSyncedAfterLogin, loadFromStorage]);
825	
826	  // å¦‚æœæ²¡æœ‰ä¼šè¯ï¼Œè‡ªåŠ¨åˆ›å»ºç¬¬ä¸€ä¸ªï¼ˆä»…åœ¨æ¸¸å®¢æ¨¡å¼æˆ–åŒæ­¥å®Œæˆåï¼‰- å»¶æ—¶æ£€æµ‹æœºåˆ¶
827	  useEffect(() => {
828	    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
829	    if (autoCreateTimeoutRef.current) {
830	      clearTimeout(autoCreateTimeoutRef.current);
831	      autoCreateTimeoutRef.current = undefined;
832	    }
833	
834	    // æ¡ä»¶Aï¼šæ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨åˆ›å»ºä¼šè¯
835	    const conditionA = sessions.length === 0 && currentSessionId === null;
836	    
837	    if (conditionA) {
838	      // æ¸¸å®¢æ¨¡å¼æˆ–å·²å®Œæˆç™»å½•åŒæ­¥çš„æƒ…å†µä¸‹æ‰å¯åŠ¨è®¡æ—¶å™¨
839	      if (!authState.isAuthenticated || hasSyncedAfterLogin) {
840	        console.log("â° æ¡ä»¶Aæ»¡è¶³ï¼Œå¯åŠ¨2ç§’å»¶æ—¶æ£€æµ‹", {
841	          mode: authState.isAuthenticated ? "ç™»å½•æ¨¡å¼" : "æ¸¸å®¢æ¨¡å¼",
842	          hasSyncedAfterLogin,
843	          sessionsLength: sessions.length,
844	          currentSessionId
845	        });
846	
847	        // å¯åŠ¨2ç§’è®¡æ—¶å™¨
848	        autoCreateTimeoutRef.current = window.setTimeout(() => {
849	          // 2ç§’åå†æ¬¡æ£€æµ‹æ¡ä»¶A
850	          const stillNeedCreate = sessions.length === 0 && currentSessionId === null;
851	          
852	          if (stillNeedCreate) {
853	            console.log("ğŸš€ æƒ…å†µ2ï¼šå»¶æ—¶æ£€æµ‹é€šè¿‡ï¼Œè‡ªåŠ¨åˆ›å»ºåˆå§‹ä¼šè¯", {
854	              mode: authState.isAuthenticated ? "ç™»å½•æ¨¡å¼" : "æ¸¸å®¢æ¨¡å¼",
855	              hasSyncedAfterLogin,
856	              reason: "2ç§’å»¶æ—¶åæ¡ä»¶Aä»ç„¶æˆç«‹"
857	            });
858	            createNewSession();
859	          } else {
860	            console.log("â¹ï¸ å»¶æ—¶æ£€æµ‹æœªé€šè¿‡ï¼Œå–æ¶ˆè‡ªåŠ¨åˆ›å»º", {
861	              sessionsLength: sessions.length,
862	              currentSessionId,
863	              reason: "2ç§’å†…æ¡ä»¶Aå·²ä¸æ»¡è¶³"
864	            });
865	          }
866	          
867	          autoCreateTimeoutRef.current = undefined;
868	        }, 2000);
869	      }
870	    }
871	  }, [
872	    sessions.length,
873	    currentSessionId,
874	    createNewSession,
875	    authState.isAuthenticated,
876	    hasSyncedAfterLogin,
877	  ]);
878	
879	  // ç»„ä»¶æŒ‚è½½æ—¶åŠ è½½æ¸¸å®¢æ•°æ®ï¼ˆä»…åœ¨æ¸¸å®¢æ¨¡å¼ä¸‹ï¼‰
880	  useEffect(() => {
881	    if (!authState.isAuthenticated) {
882	      loadFromStorage();
883	    }
884	  }, [authState.isAuthenticated, loadFromStorage]);
885	
886	  // æ¸…ç†å®šæ—¶å™¨
887	  useEffect(() => {
888	    return () => {
889	      if (saveTimeoutRef.current) {
890	        clearTimeout(saveTimeoutRef.current);
891	      }
892	      if (autoCreateTimeoutRef.current) {
893	        clearTimeout(autoCreateTimeoutRef.current);
894	      }
895	    };
896	  }, []);
897	
898	  return {
899	    sessions,
900	    currentSessionId,
901	    currentSession,
902	    isAILoading,
903	    currentModel,
904	    isSessionGenerating,
905	    createNewSession,
906	    switchToSession,
907	    deleteSession,
908	    updateSessionTitle,
909	    addMessage,
910	    updateMessage,
911	    sendMessage,
912	    stopGeneration,
913	    setCurrentModel: handleSetCurrentModel,
914	    handleNewChat,
915	    // é«˜çº§è®¾ç½®å¯¼å‡º
916	    temperature,
917	    topP,
918	    systemPrompt,
919	    setTemperature,
920	    setTopP,
921	    setSystemPrompt,
922	    // RAG è®¾ç½®å¯¼å‡º
923	    kbEnabled,
924	    setKbEnabled,
925	    kbCollectionId,
926	    setKbCollectionId,
927	  };
928	};
